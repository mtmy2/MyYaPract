Брифинг на задачу
Помните, Алиса говорила о переговорах с заказчиком? Этот час настал. Откройте чат, чтобы пообщаться с заказчиком и собрать все требования.
Заказчик
Привет! Алиса сказала, что с тобой можно обсудить требования к решению.
У нас сейчас есть три тестовых источника данных, мы бы хотели на их основе получить отчёт по продажам мастеров за период. Ещё у нас есть задача, которую тоже было бы неплохо быстро реализовать в хранилище: нужен отчёт, на основе которого можно будет сделать выводы о тенденции суммы выручки за каждый месяц с учётом года, о среднем возрасте целевой аудитории, покупающей товары ручной работы, и других полезных штуках. Задача разовая, не нужно будет эту витрину каждый раз регламентно рассчитывать.
Марат
Привет! А что именно должны содержать отчёты? Какие поля включить в них?
Заказчик
В инкрементальном отчёте по продажам мастеров должны быть следующие поля:
craftsman_id — идентификатор мастера;
craftsman_name — Ф. И. О. мастера;
craftsman_address — адрес мастера;
craftsman_birthday — дата рождения мастера;
craftsman_email — электронная почта мастера;
craftsman_money — деньги, которые заработал мастер (-10% на платформы) за месяц. Эта колонка вычисляемая.
platform_money — сумма, которую заработала платформа от продаж мастера за месяц. Эта колонка вычисляемая.
count_order — количество заказов у мастера за месяц. Эта вычисляемая колонка.
avg_price_order — средняя стоимость одного заказа у мастера за месяц. Это вычисляемая колонка.
avg_age_customer — средний возраст покупателей. Это вычисляемая колонка.
median_time_order_completed — медианное время в днях от момента создания заказа до его завершения за месяц. Это вычисляемое поле.
top_product_category — самая популярная категория товаров у этого мастера за месяц.
count_order_created — количество созданных заказов за месяц. Это вычисляемая колонка с условием.
count_order_in_progress — количество заказов в процессе изготовки за месяц. Это вычисляемая колонка с условием.
count_order_delivery — количество заказов в доставке за месяц. Это вычисляемая колонка с условием.
count_order_done — количество завершённых заказов за месяц. Это вычисляемая колонка с условием.
count_order_not_done — количество незавершённых заказов за месяц. Это вычисляемая колонка с условием.
report_period — отчётный период, год и месяц.
Для второго отчёта нужны такие поля (с группировкой по месяцам):
total_money — общая стоимость по всем заказам;
total_products — количество заказанных товаров;
avg_age_craftsman — средний возраст мастера;
avg_age_customer — средний возраст заказчика;
count_order_created — количество созданных заказов;
count_order_in_progress — количество заказов в процессе изготовки;
count_order_delivery — количество заказов в доставке;
count_order_done — количество завершённых заказов за месяц;
count_order_not_done — количество незавершённых заказов за месяц;
avg_days_complete_orders — среднее количество дней на выполнение заказа;
median_days_complete_orders — медианное количество дней на выполнение заказа.
Марат
«Медианное время в днях от момента создания заказа до его завершения за месяц» — как именно должно вычисляться это поле?
Заказчик
Медиану можно посчитать с помощью агрегатной функции percentile_cont(0.5) WITHIN GROUP(ORDER BY column) — эта функция считает перцентиль, в нашем случае 50-й (0.5) от всех значений столбца column. Другими словами, эта функция вернёт значение, которое равноудалено от максимального и минимального значения колонки column. Что и есть медиана.
Как скоро вы сможете предоставить драфт второй витрины? Нам нужно быстро получить эти данные.
Марат
О, то есть вам нужен быстрый результат? А планируете ли вы расширять хранилище, добавлять новые бизнес-области?
Заказчик
Думаю, в обозримом будущем — нет. Данные о мастерах, изделиях, заказах и клиентах — это основа, которую мы анализируем.
Марат
Понятно. Хотелось бы также узнать, какой глубины данные хранятся на источнике и какую дельту нам следует забирать к себе.
Заказчик
На данный момент мы хотим хранить в таблицах, которые мы вам предоставили в качестве источников, только новые или изменённые строки за последние сутки. Все данные старше суток будут затёрты.
Кстати, пока что давайте будем хранить только одну версию записи — самую новую. То есть, если пришло обновление строки, которая уже есть в хранилище, старая версия затирается, а новая — записывается в хранилище.
Марат
Хорошо. А в каком виде вам нужны итоговые витрины — файл, дашборд?
Заказчик
Нужен дашборд в Metabase.
Марат
Отлично, спасибо! А какие для этого нужны таблички?
Отлично, спасибо!
Итак, требования вы собрали. Следующий шаг — составить план решения задачи. Самое время отправиться к Алисе, чтобы обсудить подход к построению хранилища и начать реализацию DWH.